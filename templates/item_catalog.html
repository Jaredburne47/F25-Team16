{% extends "base.html" %}
{% block title %}Item Catalog - Driver Incentive Program{% endblock %}

{% block content %}
<!-- Header with active sponsor + points -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div class="d-flex align-items-center gap-3">
    <h1 class="mb-0">Item Catalog</h1>
    <a href="{{ url_for('cart_page') }}" class="btn btn-outline-success">ðŸ›’ View Cart</a>
  </div>
  <div class="text-end">
    {% if sponsor and sponsor != 'none' %}
      <div class="mb-1">
        <span class="badge bg-primary">Active sponsor: {{ sponsor }}</span>
      </div>
      <div>Points: <span class="badge bg-success">{{ points_balance }}</span></div>
    {% else %}
      <div class="alert alert-warning py-1 px-2 mb-0">
        No active sponsor â€” apply and get accepted to shop.
      </div>
    {% endif %}
  </div>
</div>

{% if not sponsors or sponsors|length == 0 %}
  <div class="alert alert-info d-flex justify-content-between align-items-center">
    <div>Youâ€™re not accepted with any sponsors yet. Apply to start shopping.</div>
    <a class="btn btn-primary btn-sm" href="{{ url_for('sponsor_browse') }}">Browse sponsors</a>
  </div>
{% endif %}

<!-- Search / Filter Form (no "All Sponsors"; this select switches active sponsor) -->
<form method="get" class="row g-3 mb-4">
  <div class="col-md-4">
    <input type="text" name="search" class="form-control" placeholder="Search product namesâ€¦" value="{{ search }}">
  </div>

  <div class="col-md-3">
    <select name="sponsor" class="form-select" {% if not sponsors or sponsors|length == 0 %}disabled{% endif %}>
      {% for s in sponsors %}
        <option value="{{ s }}" {% if sponsor == s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
    <div class="form-text">Switch active sponsor</div>
  </div>

  <div class="col-md-3">
    <select name="sort" class="form-select">
      <option value="points_cost_asc"  {% if sort == 'points_cost_asc'  %}selected{% endif %}>Cost (Low â†’ High)</option>
      <option value="points_cost_desc" {% if sort == 'points_cost_desc' %}selected{% endif %}>Cost (High â†’ Low)</option>
      <option value="name_asc"         {% if sort == 'name_asc'         %}selected{% endif %}>Name (A â†’ Z)</option>
      <option value="name_desc"        {% if sort == 'name_desc'        %}selected{% endif %}>Name (Z â†’ A)</option>
    </select>
  </div>

  <div class="col-md-2 d-flex align-items-center">
    <div class="form-check ms-md-2">
      <input class="form-check-input" type="checkbox" id="favOnly" name="favorites" value="1" {% if favorites_only %}checked{% endif %}>
      <label class="form-check-label" for="favOnly">Favorites only</label>
    </div>
  </div>

  <div class="col-md-2">
    <button class="btn btn-primary w-100" type="submit" {% if not sponsors or sponsors|length == 0 %}disabled{% endif %}>Apply</button>
  </div>
</form>

<!-- Products List -->
<div class="row">
  {% for item in items %}
  {% set agg = (review_agg[item.product_id] if review_agg is defined and item.product_id in review_agg else None) %}
  <div class="col-md-4 mb-4">
    <div class="card h-100 shadow-sm position-relative">
      {% if item.image_url %}
        <img src="{{ item.image_url }}" class="card-img-top" style="object-fit:contain;height:200px;">
      {% endif %}

      <!-- â­ Favorite Toggle Button -->
      <button
        class="btn btn-sm {% if favorite_ids and item.product_id in favorite_ids %}btn-warning{% else %}btn-outline-warning{% endif %} position-absolute top-0 end-0 m-2"
        style="border-radius:50%;"
        title="Favorite"
        onclick="toggleFavorite({{ item.product_id }}, this)"
        aria-label="Toggle favorite"
      >
        {% if favorite_ids and item.product_id in favorite_ids %}â˜…{% else %}â˜†{% endif %}
      </button>

      <div class="card-body d-flex flex-column">
        <h5 class="card-title mb-1">{{ item.name }}</h5>

        <!-- â˜… Average rating + count -->
        <div class="mb-2 small text-muted d-flex align-items-center gap-2">
          <span class="rating-stars" data-avg="{{ agg.avg_rating if agg else 0 }}">
            {% if agg %}
              {% for i in range(1,6) %}
                {% if i <= (agg.avg_rating|round(0, 'floor')) %}â˜…{% else %}â˜†{% endif %}
              {% endfor %}
            {% else %}
              â˜†â˜†â˜†â˜†â˜†
            {% endif %}
          </span>
          <span class="rating-label">
            {% if agg %}
              {{ '%.1f'|format(agg.avg_rating) }} ({{ agg.review_count }})
            {% else %}
              No reviews yet
            {% endif %}
          </span>
          <button class="btn btn-link btn-sm p-0 ms-auto" data-bs-toggle="modal" data-bs-target="#reviewsModal-{{ item.product_id }}">
            Reviews
          </button>
        </div>

        <p class="text-muted small mb-1">Sponsor: {{ item.sponsor }}</p>
        <p class="mb-1"><strong>{{ item.points_cost }} pts</strong></p>
        {% if item.price_value %}
          <p class="text-muted mb-1">Ref: ${{ item.price_value }} {{ item.price_currency }}</p>
        {% endif %}
        <p class="text-muted small mb-3">Quantity: {{ item.quantity }}</p>

        <!-- Add to Cart -->
        <button class="btn btn-outline-primary mt-auto w-100"
                onclick="addToCart({{ item.product_id }})"
                {% if item.quantity|int <= 0 %} disabled title="Out of stock" {% endif %}>
          Add to Cart
        </button>
      </div>
    </div>
  </div>

  <!-- Reviews Modal (per item) -->
  <div class="modal fade" id="reviewsModal-{{ item.product_id }}" tabindex="-1" aria-labelledby="reviewsLabel-{{ item.product_id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="reviewsLabel-{{ item.product_id }}" class="modal-title">Reviews â€” {{ item.name }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <!-- Aggregate summary -->
          <div class="d-flex align-items-center gap-2 mb-3">
            <div class="fs-5" id="agg-stars-{{ item.product_id }}">â˜†â˜†â˜†â˜†â˜†</div>
            <div class="small text-muted" id="agg-text-{{ item.product_id }}">
              {% if agg %}
                {{ '%.1f'|format(agg.avg_rating) }} average Â· {{ agg.review_count }} review{{ '' if agg.review_count==1 else 's' }}
              {% else %}
                No reviews yet
              {% endif %}
            </div>
          </div>

          <!-- Reviews list -->
          <div id="reviews-list-{{ item.product_id }}" class="vstack gap-3">
            <div class="text-muted small">Loading reviewsâ€¦</div>
          </div>

          <hr>

          <!-- Leave a review -->
          <form class="mt-3" onsubmit="return submitReview(event, {{ item.product_id }})">
            <label class="form-label mb-1">Your Rating</label>
            <div class="d-flex align-items-center gap-2 mb-2">
              <div class="review-stars" data-input="rating-{{ item.product_id }}" tabindex="0"
                   aria-label="Select rating from 1 to 5 stars">â˜†â˜†â˜†â˜†â˜†</div>
              <input type="hidden" id="rating-{{ item.product_id }}" name="rating" value="5">
              <span class="small text-muted">(5 = great)</span>
            </div>

            <label class="form-label">Comment (optional)</label>
            <textarea class="form-control mb-3" id="comment-{{ item.product_id }}" rows="3" maxlength="1000"
                      placeholder="Share something helpful for other driversâ€¦"></textarea>

            <button class="btn btn-primary" type="submit">Submit Review</button>
            <span class="small ms-2 text-muted" id="review-status-{{ item.product_id }}"></span>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}

  {% if items|length == 0 %}
  <p class="text-center text-muted mt-4">No products found.</p>
  {% endif %}
</div>

<!-- JS (unchanged except for context text) -->
<script>
// ---------- Favorite toggle ----------
async function toggleFavorite(productId, btnEl) {
  const isFav = btnEl.classList.contains('btn-warning');
  const url = isFav ? '/api/driver/favorites/remove' : '/api/driver/favorites/add';

  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ product_id: productId })
    });

    if (res.status === 404) {
      if (isFav) {
        btnEl.classList.remove('btn-warning');
        btnEl.classList.add('btn-outline-warning');
        btnEl.textContent = 'â˜†';
      } else {
        btnEl.classList.remove('btn-outline-warning');
        btnEl.classList.add('btn-warning');
        btnEl.textContent = 'â˜…';
      }
      return;
    }

    const data = await res.json();
    if (data.ok) {
      if (isFav) {
        btnEl.classList.remove('btn-warning');
        btnEl.classList.add('btn-outline-warning');
        btnEl.textContent = 'â˜†';
      } else {
        btnEl.classList.remove('btn-outline-warning');
        btnEl.classList.add('btn-warning');
        btnEl.textContent = 'â˜…';
      }
    } else {
      alert('Error: ' + (data.error || 'unknown'));
    }
  } catch (e) {
    alert('Network error');
  }
}

// ---------- Add to Cart (with green âœ“) ----------
async function addToCart(productId) {
  const btn = event.target;
  btn.disabled = true;
  btn.innerHTML = 'Adding...';

  try {
    const res = await fetch('/api/driver/cart/add', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ product_id: productId, quantity: 1 })
    });
    const data = await res.json();

    if (data.ok) {
      btn.classList.remove('btn-outline-primary');
      btn.classList.add('btn-success');
      btn.innerHTML = '<span class="text-white fw-bold">âœ” Added</span>';

      setTimeout(() => {
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-primary');
        btn.innerHTML = 'Add to Cart';
        btn.disabled = false;
      }, 2500);
    } else {
      alert('Error: ' + (data.error || 'unknown'));
      btn.disabled = false;
      btn.innerHTML = 'Add to Cart';
    }
  } catch (e) {
    alert('Network error');
    btn.disabled = false;
    btn.innerHTML = 'Add to Cart';
  }
}

// ---------- Rating star helpers ----------
function renderStars(avg, outEl) {
  const full = Math.floor(avg);
  let stars = '';
  for (let i = 1; i <= 5; i++) stars += (i <= full) ? 'â˜…' : 'â˜†';
  outEl.textContent = stars;
}

function attachInteractiveStars() {
  document.querySelectorAll('.review-stars').forEach(el => {
    const inputId = el.getAttribute('data-input');
    const hidden = document.getElementById(inputId);
    let current = parseInt(hidden.value || '5', 10);

    const update = (n) => {
      current = Math.min(5, Math.max(1, n));
      let stars = '';
      for (let i = 1; i <= 5; i++) stars += (i <= current) ? 'â˜…' : 'â˜†';
      el.textContent = stars;
      hidden.value = String(current);
    };

    // Init
    update(current);

    el.addEventListener('mousemove', (e) => {
      const rect = el.getBoundingClientRect();
      const rel = e.clientX - rect.left;
      const width = rect.width;
      const hovered = Math.ceil((rel / width) * 5);
      let stars = '';
      for (let i = 1; i <= 5; i++) stars += (i <= hovered) ? 'â˜…' : 'â˜†';
      el.textContent = stars;
    });

    el.addEventListener('mouseleave', () => update(current));
    el.addEventListener('click', (e) => {
      const rect = el.getBoundingClientRect();
      const rel = e.clientX - rect.left;
      const width = rect.width;
      const chosen = Math.ceil((rel / width) * 5);
      update(chosen);
    });

    el.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') { update(current - 1); }
      if (e.key === 'ArrowRight') { update(current + 1); }
    });
  });
}

// ---------- Reviews: load / submit ----------
async function loadReviews(productId) {
  const listEl = document.getElementById(`reviews-list-${productId}`);
  const aggStarsEl = document.getElementById(`agg-stars-${productId}`);
  const aggTextEl = document.getElementById(`agg-text-${productId}`);

  listEl.innerHTML = '<div class="text-muted small">Loading reviewsâ€¦</div>';
  try {
    const res = await fetch(`/api/products/${productId}/reviews`);
    if (!res.ok) {
      listEl.innerHTML = '<div class="text-muted small">Reviews not available yet.</div>';
      return;
    }

    const data = await res.json();
    if (!data.ok) {
      listEl.innerHTML = '<div class="text-danger small">Failed to load reviews.</div>';
      return;
    }

    const reviews = data.reviews || [];
    const avg = Number((data.aggregate && data.aggregate.avg_rating) || 0);
    const count = Number((data.aggregate && data.aggregate.review_count) || reviews.length || 0);

    renderStars(avg, aggStarsEl);
    aggTextEl.textContent = count
      ? `${avg.toFixed(1)} average Â· ${count} review${count===1?'':'s'}`
      : 'No reviews yet';

    if (!reviews.length) {
      listEl.innerHTML = '<div class="text-muted small">Be the first to review.</div>';
    } else {
      listEl.innerHTML = reviews.map(r => {
        const created = r.created_date || '';
        const rating = Math.max(1, Math.min(5, Number(r.rating || 0)));
        const stars = 'â˜…â˜…â˜…â˜…â˜…'.slice(0, rating) + 'â˜†â˜†â˜†â˜†â˜†'.slice(0, 5 - rating);
        const uname = r.driver_username || 'Driver';
        const text = (r.body || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const title = (r.title || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');

        return `
          <div class="border rounded p-2">
            <div class="d-flex justify-content-between">
              <div class="fw-semibold">${uname}</div>
              <div class="small text-muted">${created}</div>
            </div>
            <div class="text-warning-emphasis" style="letter-spacing:1px;">${stars}</div>
            ${title ? `<div class="mt-1 fw-semibold">${title}</div>` : ''}
            <div class="mt-1">${text}</div>
          </div>
        `;
      }).join('');
    }
  } catch (e) {
    listEl.innerHTML = '<div class="text-danger small">Failed to load reviews.</div>';
  }
}

async function submitReview(ev, productId) {
  ev.preventDefault();
  const ratingEl = document.getElementById(`rating-${productId}`);
  const commentEl = document.getElementById(`comment-${productId}`);
  const statusEl = document.getElementById(`review-status-${productId}`);

  const payload = {
    rating: Number(ratingEl.value || '5'),
    title: '',
    body: commentEl.value.trim()
  };

  statusEl.textContent = 'Submittingâ€¦';
  try {
    const res = await fetch(`/api/products/${productId}/reviews`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (res.ok && data.ok) {
      statusEl.textContent = 'Thanks for your review!';
      commentEl.value = '';
      await loadReviews(productId);
    } else {
      statusEl.textContent = 'Error: ' + (data.error || 'unknown');
    }
  } catch (e) {
    statusEl.textContent = 'Network error.';
  }
  return false;
}

// When any reviews modal opens, load its reviews
document.addEventListener('shown.bs.modal', (e) => {
  const id = e.target?.id || '';
  if (id.startsWith('reviewsModal-')) {
    const pid = Number(id.split('-')[1]);
    if (pid) loadReviews(pid);
  }
});

// Enhance static avg-star placeholders (in cards)
document.querySelectorAll('.rating-stars').forEach(el => {
  const avg = Number(el.getAttribute('data-avg') || '0');
  const full = Math.floor(avg);
  let s = '';
  for (let i = 1; i <= 5; i++) s += (i <= full) ? 'â˜…' : 'â˜†';
  el.textContent = s;
});

// Activate interactive star widgets
attachInteractiveStars();
</script>
{% endblock %}
