{% extends "base.html" %}
{% block title %}Audit Logs{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h2 class="mb-0">Audit Logs</h2>
  </div>

  <!-- Filters Card -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="POST" action="{{ url_for('audit_logs') }}" class="m-0">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label for="action" class="form-label fw-semibold">Log Type</label>
            <select name="action" id="action" class="form-select">
              <option value="all" {{ 'selected' if request.form.get('action','all') == 'all' else '' }}>All Logs</option>
              <option value="log in attempt" {{ 'selected' if request.form.get('action') == 'log in attempt' else '' }}>Log In Attempt</option>
              <option value="application" {{ 'selected' if request.form.get('action') == 'application' else '' }}>Application</option>
              <option value="password reset" {{ 'selected' if request.form.get('action') == 'password reset' else '' }}>Password Reset</option>
              <option value="point history" {{ 'selected' if request.form.get('action') == 'point history' else '' }}>Point History</option>
              <option value="feedback" {{ 'selected' if request.form.get('action') == 'feedback' else '' }}>Feedback</option>
            </select>
          </div>

          <div class="col-md-3">
            <label for="user_id" class="form-label fw-semibold">User ID</label>
            <input type="text" name="user_id" id="user_id" class="form-control" placeholder="Enter user id" value="{{ request.form.get('user_id','') }}">
          </div>

          <div class="col-md-3">
            <label for="start_date" class="form-label fw-semibold">Start Date</label>
            <input type="date" name="start_date" id="start_date" class="form-control" value="{{ request.form.get('start_date','') }}">
          </div>

          <div class="col-md-3">
            <label for="end_date" class="form-label fw-semibold">End Date</label>
            <input type="date" name="end_date" id="end_date" class="form-control" value="{{ request.form.get('end_date','') }}">
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button type="submit" class="btn btn-primary btn-sm px-3">View Logs in Browser</button>
          <!-- CSV download preserves current filter values via a second form submit -->
          <form method="POST" action="{{ url_for('download_audit_logs') }}" class="m-0">
            <input type="hidden" name="action" value="{{ request.form.get('action','all') }}">
            <input type="hidden" name="user_id" value="{{ request.form.get('user_id','') }}">
            <input type="hidden" name="start_date" value="{{ request.form.get('start_date','') }}">
            <input type="hidden" name="end_date" value="{{ request.form.get('end_date','') }}">
            <button type="submit" class="btn btn-success btn-sm px-3">Download as CSV</button>
          </form>
        </div>
      </form>
    </div>
  </div>

  <!-- Results Table -->
  {% if logs and logs|length > 0 %}
    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th style="width: 18%;">Timestamp</th>
            <th style="width: 16%;">Action</th>
            <th>Description</th>
            <th style="width: 14%;" class="text-end">User ID</th>
          </tr>
        </thead>
        <tbody>
          {% for log in logs %}
          <tr>
            <td class="text-nowrap">{{ log.timestamp }}</td>
            <td><span class="fw-semibold">{{ log.action }}</span></td>
            <td>{{ log.description }}</td>
            <td class="text-end">{{ log.user_id }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-secondary mt-3" role="alert">
      No logs found for the selected filters.
    </div>
  {% endif %}
</div>
{% endblock %}
