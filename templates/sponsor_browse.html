{% extends "base.html" %}
{% block title %}Browse Sponsors{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- ======================= -->
  <!-- My Sponsors (Accepted)  -->
  <!-- ======================= -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h2 class="mb-0">My Sponsors</h2>
  </div>

  <div class="table-responsive mb-4">
    <table class="table table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th style="width: 30%">Sponsor</th>
          <th style="width: 50%">Organization</th>
          <th style="width: 20%" class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if my_sponsors and my_sponsors|length > 0 %}
          {% for sp in my_sponsors %}
          <tr>
            <td class="fw-semibold">{{ sp.username }}</td>
            <td>{{ sp.organization or '-' }}</td>
            <td class="text-end">
              <div class="btn-group">
                <a class="btn btn-outline-primary btn-sm"
                   href="{{ url_for('item_catalog', sponsor=sp.username) }}">
                   View Catalog
                </a>
                <form method="POST" action="{{ url_for('drop_sponsor', sponsor=sp.username) }}" class="ms-2">
                  <button type="submit" class="btn btn-outline-danger btn-sm"
                          onclick="return confirm('Are you sure you want to drop this sponsor?');">
                    Drop Sponsor
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="3" class="text-muted">You have no accepted sponsors yet.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- ======================= -->
  <!-- Available Sponsors      -->
  <!-- ======================= -->
  <h2>Available Sponsors</h2>
  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th style="width: 25%">Sponsor</th>
          <th style="width: 45%">Organization</th>
          <th style="width: 15%">Status</th>
          <th style="width: 15%" class="text-end">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for sponsor in sponsors %}
        {% set st = sponsor.my_status %}
        <tr>
          <td class="fw-semibold">{{ sponsor.username }}</td>
          <td>{{ sponsor.organization or '-' }}</td>
          <td>
            {% if st == 'accepted' %}
              <span class="badge bg-success">accepted</span>
            {% elif st == 'pending' %}
              <span class="badge bg-warning text-dark">pending</span>
            {% elif st == 'rejected' %}
              <span class="badge bg-danger">rejected</span>
            {% elif st == 'withdrawn' %}
              <span class="badge bg-secondary">withdrawn</span>
            {% elif st == 'dropped' %}
              <span class="badge bg-secondary">dropped</span>
            {% else %}
              <span class="badge bg-light text-dark">no application</span>
            {% endif %}
          </td>
          <td class="text-end">
            {% if st == 'accepted' %}
              <!-- Replace Apply with Drop Sponsor -->
              <form method="POST" action="{{ url_for('drop_sponsor', sponsor=sponsor.username) }}" class="m-0">
                <button type="submit"
                        class="btn btn-outline-danger btn-sm"
                        onclick="return confirm('Are you sure you want to drop this sponsor?');">
                  Drop Sponsor
                </button>
              </form>
            {% else %}
              <!-- Show Apply if not accepted -->
              <form method="POST" action="{{ url_for('apply_to_sponsor', sponsor=sponsor.username) }}" class="m-0">
                <button type="submit"
                        class="btn btn-primary btn-sm"
                        {% if st in ['pending'] %}
                          disabled title="You already have an active application with this sponsor."
                        {% endif %}>
                  Apply
                </button>
              </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% if sponsors|length == 0 %}
        <tr>
          <td colspan="4" class="text-muted">No sponsors found.</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
