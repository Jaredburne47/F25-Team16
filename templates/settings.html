{% extends "base.html" %}
{% block title %}Settings{% endblock %}

{% block content %}
{% set cancel_url =
    (url_for('admin_profile')   if session.get('role') == 'admin'   else
     url_for('driver_profile')  if session.get('role') == 'driver'  else
     url_for('sponsor_profile') if session.get('role') == 'sponsor' else
     url_for('dashboard')) %}

<div class="container mt-4">
  <!-- ========================= -->
  <!-- Page Header               -->
  <!-- ========================= -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h2 class="mb-0">Edit Profile</h2>
  </div>

  <!-- ========================= -->
  <!-- Profile + Password (Card) -->
  <!-- ========================= -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="POST" enctype="multipart/form-data" class="m-0">
        <!-- Profile Picture -->
        <div class="text-center mb-4">
          <img id="profilePreview"
               src="{{ url_for('static', filename='uploads/profile_pics/' ~ (user.profile_picture if user.profile_picture else 'Default.jpg')) }}"
               alt="Profile Picture"
               class="img-thumbnail rounded-circle mb-2"
               width="150" height="150">
          <div class="mx-auto" style="max-width: 360px;">
            <input type="file" class="form-control form-control-sm" id="profile_picture" name="profile_picture" accept="image/*" onchange="previewImage(event)">
          </div>
        </div>

        <!-- Identity -->
        <div class="row g-3">
          <div class="col-12">
            <label for="username" class="form-label mb-1">Username</label>
            <input type="text" class="form-control" id="username" name="username" value="{{ user.username }}" readonly>
          </div>
          <div class="col-md-6">
            <label for="first_name" class="form-label mb-1">First Name</label>
            <input type="text" class="form-control" id="first_name" name="first_name" value="{{ user.first_name }}">
          </div>
          <div class="col-md-6">
            <label for="last_name" class="form-label mb-1">Last Name</label>
            <input type="text" class="form-control" id="last_name" name="last_name" value="{{ user.last_name }}">
          </div>
        </div>

       <!-- Contact -->
    <div class="row g-3 mt-1">
      <div class="col-12">
        <label for="address" class="form-label mb-1">Address</label>
        <div class="input-group">
          <input type="text" class="form-control" id="address" name="address"
                 value="{{ user.address }}" autocomplete="off">
          <button type="button" class="btn btn-outline-secondary"
                  onclick="toggleMask('address', this)" aria-pressed="false"
                  aria-label="Toggle address visibility">üëÅ</button>
        </div>
      </div>
    
      <div class="col-md-6">
        <label for="phone" class="form-label mb-1">Phone Number</label>
        <div class="input-group">
          <input type="text" class="form-control" id="phone" name="phone"
                 value="{{ user.phone }}" autocomplete="off">
          <button type="button" class="btn btn-outline-secondary"
                  onclick="toggleMask('phone', this)" aria-pressed="false"
                  aria-label="Toggle phone visibility">üëÅ</button>
        </div>
      </div>
    </div>

        {% if session.get('role') in ['sponsor', 'driver'] %}
        <!-- Socials -->
        <hr class="my-4">
        <h6 class="text-muted mb-3">Social Profiles</h6>
        <div class="row g-3">
          <div class="col-md-4">
            <label for="twitter" class="form-label mb-1">Twitter</label>
            <input type="text" class="form-control" id="twitter" name="twitter" value="{{ user.twitter }}">
          </div>
          <div class="col-md-4">
            <label for="facebook" class="form-label mb-1">Facebook</label>
            <input type="text" class="form-control" id="facebook" name="facebook" value="{{ user.facebook }}">
          </div>
          <div class="col-md-4">
            <label for="instagram" class="form-label mb-1">Instagram</label>
            <input type="text" class="form-control" id="instagram" name="instagram" value="{{ user.instagram }}">
          </div>
        </div>
        {% endif %}

        {% if session.get('role') == 'driver' %}
        <!-- Vehicle -->
        <hr class="my-4">
        <h6 class="text-muted mb-3">Vehicle</h6>
        <div class="row g-3">
          <div class="col-md-4">
            <label for="vehicle_make" class="form-label mb-1">Make</label>
            <input type="text" class="form-control" id="vehicle_make" name="vehicle_make" value="{{ user.vehicle_make }}">
          </div>
          <div class="col-md-4">
            <label for="vehicle_model" class="form-label mb-1">Model</label>
            <input type="text" class="form-control" id="vehicle_model" name="vehicle_model" value="{{ user.vehicle_model }}">
          </div>
          <div class="col-md-4">
            <label for="vehicle_year" class="form-label mb-1">Year</label>
            <input type="text" class="form-control" id="vehicle_year" name="vehicle_year" value="{{ user.vehicle_year }}">
          </div>
        </div>
        {% endif %}

        {% if session.get('role') == 'sponsor' %}
        <!-- Sponsor org -->
        <hr class="my-4">
        <h6 class="text-muted mb-3">Organization</h6>
        <div class="row g-3">
          <div class="col-md-6">
            <label for="organization" class="form-label mb-1">Organization</label>
            <input type="text" class="form-control" id="organization" name="organization" value="{{ user.organization }}">
          </div>
          <div class="col-md-6">
            <label for="company_link" class="form-label mb-1">Company Link</label>
            <input type="text" class="form-control" id="company_link" name="company_link" value="{{ user.company_link }}">
          </div>
        </div>

        <!-- Company Logo -->
        <div class="row g-3 mt-1">
          <div class="col-lg-6">
            <label class="form-label mb-2">Company Logo</label><br>
            <img id="logoPreview"
                 src="{{ url_for('static', filename='uploads/company_logos/' ~ (user.company_logo if user.company_logo else 'Default_Logo.png')) }}"
                 alt="Company Logo Preview"
                 class="img-thumbnail mb-2"
                 style="max-width: 200px; max-height: 150px;">
            <input type="file" class="form-control form-control-sm" id="company_logo" name="company_logo" accept="image/*" onchange="previewLogo(event)">
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" name="remove_logo" id="removeLogoCheck">
              <label class="form-check-label" for="removeLogoCheck">Remove current logo</label>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Password Settings -->
        <hr class="my-4">
        <h6 class="text-danger mb-1">Password</h6>
        <p class="text-muted"><small>Your password is hidden by default. Use the üëÅ button to toggle visibility.</small></p>

        <div class="row g-3">
          <div class="col-md-6">
            <div class="input-group">
              <input type="password" class="form-control" id="password" name="password" placeholder="Leave blank to keep current password">
              <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('password')">üëÅ</button>
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <input type="password" class="form-control" id="confirm_password" name="confirm_password" placeholder="Re-enter new password">
              <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirm_password')">üëÅ</button>
            </div>
          </div>
        </div>

        <div class="d-flex align-items-center gap-2 mt-4">
          <button type="submit" class="btn btn-success btn-sm px-3">Save Changes</button>
          <a href="{{ cancel_url }}" class="btn btn-outline-secondary btn-sm px-3">Cancel</a>
        </div>
      </form>
    </div>
  </div>

  <!-- ================================ -->
  <!-- Email Notification Preferences  -->
  <!-- ================================ -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">Email Notification Preferences</h5>

      <form action="{{ url_for('update_notifications') }}" method="post" class="m-0">
        <div class="row g-3">
          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="receive_emails" id="receive_emails" {% if user.receive_emails %}checked{% endif %}>
              <label class="form-check-label" for="receive_emails">Receive any emails</label>
            </div>
          </div>

          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="login_email" id="login_email" {% if user.login_email %}checked{% endif %}>
              <label class="form-check-label" for="login_email">Login alerts</label>
            </div>
          </div>

          {% if session.get('role') == 'driver' %}
          <div class="col-12"><hr class="my-2"></div>
          <div class="col-12"><h6 class="text-muted">Driver Notifications</h6></div>

          <div class="col-md-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="low_balance_email" id="low_balance_email" {% if user.low_balance_email %}checked{% endif %}>
              <label class="form-check-label" for="low_balance_email">Low balance alerts</label>
            </div>
          </div>

          <div class="col-md-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="points_added_email" id="points_added_email" {% if user.points_added_email %}checked{% endif %}>
              <label class="form-check-label" for="points_added_email">Points added notifications</label>
            </div>
          </div>

          <div class="col-md-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="points_removed_email" id="points_removed_email" {% if user.points_removed_email %}checked{% endif %}>
              <label class="form-check-label" for="points_removed_email">Points removed notifications</label>
            </div>
          </div>

          <div class="col-md-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="driver_dropped_email" id="driver_dropped_email" {% if user.driver_dropped_email %}checked{% endif %}>
              <label class="form-check-label" for="driver_dropped_email">Sponsor dropped me alerts</label>
            </div>
          </div>

          <div class="col-md-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="spend_points_email" id="spend_points_email" {% if user.spend_points_email %}checked{% endif %}>
              <label class="form-check-label" for="spend_points_email">Purchase confirmation (Spend points)</label>
            </div>
          </div>

          <!-- NEW DRIVER PREFS -->
          <div class="col-md-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="favorite_back_in_stock_email" id="favorite_back_in_stock_email" {% if user.favorite_back_in_stock_email %}checked{% endif %}>
              <label class="form-check-label" for="favorite_back_in_stock_email">Favorites back in stock</label>
            </div>
          </div>

          <div class="col-md-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="new_item_email" id="new_item_email" {% if user.new_item_email %}checked{% endif %}>
              <label class="form-check-label" for="new_item_email">New items from my sponsors</label>
            </div>
          </div>

          <div class="col-md-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="order_placed_email" id="order_placed_email" {% if user.order_placed_email %}checked{% endif %}>
              <label class="form-check-label" for="order_placed_email">Order placed confirmation</label>
            </div>
          </div>
          {% endif %}

          {% if session.get('role') == 'sponsor' %}
          <div class="col-12"><hr class="my-2"></div>
          <div class="col-12"><h6 class="text-muted">Sponsor Notifications</h6></div>

          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="driver_app_email" id="driver_app_email" {% if user.driver_app_email %}checked{% endif %}>
              <label class="form-check-label" for="driver_app_email">New driver application notifications</label>
            </div>
          </div>
          {% endif %}

          {% if session.get('role') == 'admin' %}
          <div class="col-12"><hr class="my-2"></div>
          <div class="col-12"><h6 class="text-muted">Admin Notifications</h6></div>

          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="sponsor_locked_email" id="sponsor_locked_email" {% if user.sponsor_locked_email %}checked{% endif %}>
              <label class="form-check-label" for="sponsor_locked_email">Sponsor locked alerts</label>
            </div>
          </div>
          {% endif %}
        </div>

        <button type="submit" class="btn btn-primary btn-sm mt-3 px-3">Save Preferences</button>
      </form>
    </div>
  </div>

  <!-- ========================= -->
  <!-- Disable Account (Card)   -->
  <!-- ========================= -->
  {% if session.get('role') in ['driver', 'sponsor'] %}
  <div class="card shadow-sm mb-4">
    <div class="card-body text-center">
      <h5 class="card-title mb-2">Disable Account</h5>
      <p class="text-muted mb-3"><small>You can reactivate your account by logging back in.</small></p>
      <form action="{{ url_for('disable_self') }}" method="POST"
            onsubmit="return confirm('Are you sure you want to disable your account? You can reactivate it later.')">
        <button type="submit" class="btn btn-dark btn-sm px-3">Disable My Account</button>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- ========================= -->
  <!-- Point Limits (Card)      -->
  <!-- ========================= -->
  {% if session.get('role') == 'sponsor' %}
  <div class="card shadow-sm mb-5">
    <div class="card-header bg-primary text-white py-3">
      <h5 class="mb-0">Point Limits</h5>
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('settings') }}" class="m-0">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="min_points" class="form-label fw-semibold mb-1">Minimum Points</label>
            <input type="number" class="form-control" id="min_points" name="min_points" value="{{ user.min_points or 0 }}" required>
          </div>
          <div class="col-md-6">
            <label for="max_points" class="form-label fw-semibold mb-1">Maximum Points</label>
            <input type="number" class="form-control" id="max_points" name="max_points" value="{{ user.max_points or 0 }}" required>
          </div>
        </div>
        <button type="submit" class="btn btn-primary btn-sm mt-3 px-3">Save Limits</button>
      </form>
    </div>
  </div>
  {% endif %}
</div>

<!-- ========================= -->
<!-- Inline Helpers            -->
<!-- ========================= -->
<script>
function togglePassword(id) {
  const field = document.getElementById(id);
  field.type = (field.type === "password") ? "text" : "password";
}
function toggleMask(id, btn){
  const el = document.getElementById(id);
  if (!el) return;
  // flip between visible text and masked
  el.type = (el.type === 'password') ? 'text' : 'password';
  if (btn) btn.setAttribute('aria-pressed', String(el.type === 'password'));
}
function previewImage(event) {
  const input = event.target;
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('profilePreview').src = e.target.result;
    }
    reader.readAsDataURL(input.files[0]);
  }
}
function previewLogo(event) {
  const input = event.target;
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('logoPreview').src = e.target.result;
    }
    reader.readAsDataURL(input.files[0]);
  }
}
</script>
{% endblock %}
