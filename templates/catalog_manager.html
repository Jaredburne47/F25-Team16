{% extends "base.html" %}
{% block title %}Catalog Manager{% endblock %}

{% block content %}
<style>
#save-ratio-btn.btn-success .save-check { color: white !important; }
#save-ratio-btn { transition: background-color 0.3s ease, color 0.3s ease; }
.btn-success .check-white { color: #fff !important; font-weight: 700; }
</style>

<div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
  <h1 class="mb-0">Catalog Manager</h1>

  <!-- Points Ratio Control -->
  <div class="d-flex align-items-center gap-2">
    <label class="form-label mb-0">Points Ratio:</label>
    <div class="input-group" style="max-width: 280px;">
      <span class="input-group-text">1 USD =</span>
      <input type="number" class="form-control" id="points-per-dollar" min="1" step="1"
             value="{{ points_ratio or 100 }}">
      <span class="input-group-text">points</span>
    </div>
    <button class="btn btn-outline-primary d-flex align-items-center" id="save-ratio-btn" type="button">
      <span class="save-text">Save</span>
      <span class="save-check d-none ms-2 fw-bold">✔</span>
    </button>
  </div>

  <div class="btn-group ms-auto">
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#ebayModal">
      Add Item
    </button>
  </div>
</div>

<!-- Products Table -->
<table class="table table-hover">
  <thead class="table-light">
    <tr>
      <th>#</th>
      <th>Name</th>
      <th>Points Cost</th>
      <th>Quantity</th>
      <th>Source</th>
      <th class="text-end">Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for product in products %}
    <tr>
      <th>{{ product.product_id }}</th>
      <td>
        {% if product.image_url %}
          <img src="{{ product.image_url }}" alt="" width="40" class="me-2 rounded">
        {% endif %}
        {{ product.name }}
        {% if product.price_value %}
          <div class="small text-muted">Ref: ${{ product.price_value }} {{ product.price_currency }}</div>
        {% endif %}
      </td>
      <td>{{ product.points_cost }}</td>
      <td>{{ product.quantity }}</td>
      <td>{{ product.source_type|default('local')|capitalize }}</td>
      <td class="text-end">
        <!-- EDIT button passes data to the single modal -->
        <button type="button"
                class="btn btn-sm btn-outline-primary me-1 edit-btn"
                data-bs-toggle="modal"
                data-bs-target="#editProductModal"
                data-product-id="{{ product.product_id }}"
                data-name="{{ product.name }}"
                data-points="{{ product.points_cost }}"
                data-qty="{{ product.quantity or 0 }}"
                data-source="{{ product.source_type|default('local') }}"
                data-ebay="{{ product.ebay_item_id|default('') }}">
          Edit
        </button>

        <form action="{{ url_for('delete_product', product_id=product.product_id) }}"
              method="POST" style="display:inline;">
          <button type="submit" class="btn btn-sm btn-danger">Delete</button>
        </form>
      </td>
    </tr>
    {% else %}
    <tr><td colspan="6" class="text-center text-muted">No products found</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- Add Local Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="add-local-item-form" action="{{ url_for('add_product') }}" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="addItemModalLabel">Add Local Product</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Product Name</label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Points Cost</label>
            <input type="number" class="form-control" name="points_cost" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Quantity</label>
            <input type="number" class="form-control" name="quantity" value="0">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="btn-add-local" type="submit" class="btn btn-primary">Add Product</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- eBay Search Modal -->
<div class="modal fade" id="ebayModal" tabindex="-1" aria-labelledby="ebayModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ebayModalLabel">Browse eBay Catalog</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="ebay-search-form" class="input-group mb-3">
          <input type="text" class="form-control" id="ebay-search-query" placeholder="Search eBay products...">
          <button class="btn btn-primary" type="submit">Search</button>
        </form>
        <div class="alert alert-secondary py-2 small">
          Points auto-calculate from the item price using your ratio (<span id="ratio-inline">100</span> pts / $1).
        </div>
        <div id="ebay-results" class="row g-3"></div>
      </div>
    </div>
  </div>
</div>

<!-- SINGLE Edit Modal (outside the table) -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductLabel"
     aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog">
    <form id="edit-form" class="modal-content" method="POST">
      <div class="modal-header">
        <h5 class="modal-title" id="editProductLabel">Edit Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Name</label>
          <input id="edit-name" class="form-control" disabled>
          <div class="form-text">Name cannot be changed here.</div>
        </div>

        <div class="mb-3">
          <label class="form-label" for="edit-points">Points Cost</label>
          <input id="edit-points" name="points_cost" type="number" min="0" step="1" class="form-control" required>
        </div>

        <div class="mb-3">
          <label class="form-label" for="edit-qty">Quantity</label>
          <input id="edit-qty" name="quantity" type="number" min="0" step="1" class="form-control" required>
        </div>

        <div class="small text-muted">
          <span id="edit-source">Source: —</span>
          <span id="edit-ebay" class="ms-2"></span>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Save changes</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ---------- Points Ratio ---------- */
const RATIO_KEY = 'points_per_dollar';
const ratioInput = document.getElementById('points-per-dollar');
const ratioInline = document.getElementById('ratio-inline');
const saveBtn = document.getElementById('save-ratio-btn');
const saveText = saveBtn.querySelector('.save-text');
const saveCheck = saveBtn.querySelector('.save-check');

(function initRatio() {
  const serverVal = Number('{{ points_ratio or 0 }}') || 0;
  let ratio = serverVal > 0 ? serverVal : Number(localStorage.getItem(RATIO_KEY)) || 100;
  ratio = Math.max(1, Math.floor(ratio));
  ratioInput.value = ratio;
  if (ratioInline) ratioInline.textContent = ratio;
})();

saveBtn.addEventListener('click', () => {
  let ratio = Math.max(1, Math.floor(Number(ratioInput.value || 100)));
  ratioInput.value = ratio;
  if (ratioInline) ratioInline.textContent = ratio;
  localStorage.setItem(RATIO_KEY, String(ratio));
  saveBtn.classList.remove('btn-outline-primary');
  saveBtn.classList.add('btn-success');
  saveText.textContent = 'Saved';
  saveCheck.classList.remove('d-none');
  setTimeout(() => {
    saveBtn.classList.remove('btn-success');
    saveBtn.classList.add('btn-outline-primary');
    saveText.textContent = 'Save';
    saveCheck.classList.add('d-none');
  }, 2000);
});

function getEffectiveRatio() {
  const serverVal = Number('{{ points_ratio or 0 }}') || 0;
  const localVal = Number(localStorage.getItem(RATIO_KEY)) || 0;
  return Math.max(1, Math.floor(serverVal || localVal || 100));
}

/* ---------- Add Local (AJAX feedback) ---------- */
const addLocalForm = document.getElementById('add-local-item-form');
if (addLocalForm) {
  addLocalForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = document.getElementById('btn-add-local');
    const originalHTML = submitBtn.innerHTML;

    const formData = new FormData(addLocalForm);
    try {
      const res = await fetch(addLocalForm.action, {
        method: 'POST',
        headers: { 'X-Requested-With': 'fetch' },
        body: formData
      });
      if (!res.ok) {
        let msg = 'Server error';
        try { const data = await res.json(); if (data.error) msg = data.error; } catch (_){}
        alert('Error: ' + msg);
        return;
      }
      submitBtn.classList.remove('btn-primary');
      submitBtn.classList.add('btn-success');
      submitBtn.innerHTML = '<span class="check-white">✔ Saved</span>';
      addLocalForm.reset();
      setTimeout(() => {
        submitBtn.classList.remove('btn-success');
        submitBtn.classList.add('btn-primary');
        submitBtn.innerHTML = originalHTML;
        location.reload(); // refresh list so new item shows
      }, 1000);
    } catch {
      alert('Network error');
    }
  });
}

/* ---------- eBay search ---------- */
document.getElementById("ebay-search-form")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  const q = document.getElementById("ebay-search-query").value.trim();
  if (!q) return;
  const container = document.getElementById("ebay-results");
  container.innerHTML = "<p class='text-muted text-center'>Searching...</p>";

  const res = await fetch(`/api/sponsor/ebay/search?q=${encodeURIComponent(q)}`);
  const data = await res.json();
  if (!data.items || !data.items.length) {
    container.innerHTML = "<p class='text-center text-muted'>No results found.</p>";
    return;
  }

  const ratio = getEffectiveRatio();
  container.innerHTML = data.items.map(item => {
    const hasPrice = item.price && item.price.value && item.price.currency;
    const isUSD = hasPrice && (String(item.price.currency).toUpperCase() === 'USD');
    const autoPoints = isUSD ? Math.ceil(Number(item.price.value) * ratio) : 100;
    return `
      <div class="col-md-4">
        <div class="card h-100 shadow-sm">
          ${item.image ? `<img src="${item.image}" class="card-img-top" style="object-fit:contain;height:180px;">` : ''}
          <div class="card-body">
            <h6 class="card-title">${item.title}</h6>
            <p class="text-muted small">${item.condition || ''}</p>
            ${hasPrice ? `<p><strong>${item.price.value} ${item.price.currency}</strong></p>` : ''}
            <div class="input-group input-group-sm mb-2">
              <span class="input-group-text">Points</span>
              <input type="number" class="form-control" id="points-${item.itemId}" value="${autoPoints}">
            </div>
            <div class="input-group input-group-sm mb-3">
              <span class="input-group-text">Qty</span>
              <input type="number" class="form-control" id="qty-${item.itemId}" value="1">
            </div>
            <button id="btn-add-${item.itemId}" class="btn btn-success w-100"
                    onclick="addToCatalog(this, '${item.itemId}')">
              Add to Catalog
            </button>
          </div>
        </div>
      </div>`;
  }).join("");
});

async function addToCatalog(btn, itemId) {
  const originalHTML = btn.innerHTML;
  btn.disabled = true;
  const points = document.getElementById(`points-${itemId}`).value;
  const quantity = document.getElementById(`qty-${itemId}`).value;
  try {
    const res = await fetch("/api/sponsor/catalog/add", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ item_id: itemId, points_cost: points, quantity_limit: quantity })
    });
    const data = await res.json();
    if (data.ok) {
      btn.classList.add('btn-success');
      btn.innerHTML = '<span class="check-white">✔ Added</span>';
      setTimeout(() => { btn.disabled = false; btn.innerHTML = originalHTML; }, 1000);
    } else {
      btn.disabled = false;
      alert("Error: " + (data.error || "unknown"));
    }
  } catch {
    btn.disabled = false;
    alert("Network error");
  }
}

/* ---------- Edit Modal wiring ---------- */
const editModalEl = document.getElementById('editProductModal');
const editForm = document.getElementById('edit-form');
const nameInput = document.getElementById('edit-name');
const ptsInput = document.getElementById('edit-points');
const qtyInput = document.getElementById('edit-qty');
const sourceSpan = document.getElementById('edit-source');
const ebaySpan = document.getElementById('edit-ebay');

editModalEl.addEventListener('show.bs.modal', (event) => {
  const btn = event.relatedTarget;
  const id = btn.getAttribute('data-product-id');
  const name = btn.getAttribute('data-name');
  const pts = btn.getAttribute('data-points');
  const qty = btn.getAttribute('data-qty');
  const source = btn.getAttribute('data-source') || 'local';
  const ebayId = btn.getAttribute('data-ebay') || '';

  nameInput.value = name || '';
  ptsInput.value = pts || 0;
  qtyInput.value = qty || 0;
  sourceSpan.textContent = `Source: ${source}`;
  ebaySpan.textContent = ebayId ? `· eBay Item: ${ebayId}` : '';

  editForm.setAttribute('action', `{{ url_for('edit_product', product_id=0)[:-1] }}${id}`);
});

editForm.addEventListener('submit', () => {
  // Let normal POST happen; optionally add client-side validation here
});
</script>
{% endblock %}
