{% extends "base.html" %}
{% block title %}Catalog Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Catalog Manager</h1>
  <div class="btn-group">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
      Add Local Item
    </button>
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#ebayModal">
      Browse eBay Catalog
    </button>
  </div>
</div>

<!-- Products Table -->
<table class="table table-hover">
  <thead class="table-light">
    <tr>
      <th>#</th>
      <th>Name</th>
      <th>Points Cost</th>
      <th>Quantity</th>
      <th>Source</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for product in products %}
    <tr>
      <th>{{ product.product_id }}</th>
      <td>
        {% if product.image_url %}
          <img src="{{ product.image_url }}" alt="" width="40" class="me-2 rounded">
        {% endif %}
        {{ product.name }}
      </td>
      <td>{{ product.points_cost }}</td>
      <td>{{ product.quantity }}</td>
      <td>{{ product.source_type|default('local')|capitalize }}</td>
      <td>
        <form action="{{ url_for('delete_product', product_id=product.product_id) }}" method="POST" style="display:inline;">
          <button type="submit" class="btn btn-sm btn-danger">Delete</button>
        </form>
      </td>
    </tr>
    {% else %}
    <tr><td colspan="6" class="text-center text-muted">No products found</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- Add Local Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('add_product') }}" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="addItemModalLabel">Add Local Product</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Product Name</label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Points Cost</label>
            <input type="number" class="form-control" name="points_cost" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Quantity</label>
            <input type="number" class="form-control" name="quantity" value="0">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Product</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- eBay Search Modal -->
<div class="modal fade" id="ebayModal" tabindex="-1" aria-labelledby="ebayModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ebayModalLabel">Browse eBay Catalog</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="ebay-search-form" class="input-group mb-3">
          <input type="text" class="form-control" id="ebay-search-query" placeholder="Search eBay products...">
          <button class="btn btn-primary" type="submit">Search</button>
        </form>
        <div id="ebay-results" class="row g-3"></div>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById("ebay-search-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const q = document.getElementById("ebay-search-query").value.trim();
  if (!q) return;

  const container = document.getElementById("ebay-results");
  container.innerHTML = "<p class='text-muted text-center'>Searching...</p>";

  const res = await fetch(`/api/sponsor/ebay/search?q=${encodeURIComponent(q)}`);
  const data = await res.json();

  if (!data.items || !data.items.length) {
    container.innerHTML = "<p class='text-center text-muted'>No results found.</p>";
    return;
  }

  container.innerHTML = data.items.map(item => `
    <div class="col-md-4">
      <div class="card h-100 shadow-sm">
        ${item.image ? `<img src="${item.image}" class="card-img-top" style="object-fit:contain;height:180px;">` : ''}
        <div class="card-body">
          <h6 class="card-title">${item.title}</h6>
          <p class="text-muted small">${item.condition || ''}</p>
          ${item.price ? `<p><strong>${item.price.value} ${item.price.currency}</strong></p>` : ''}
          <div class="input-group input-group-sm mb-2">
            <span class="input-group-text">Points</span>
            <input type="number" class="form-control" id="points-${item.itemId}" value="100">
          </div>
          <div class="input-group input-group-sm mb-3">
            <span class="input-group-text">Qty</span>
            <input type="number" class="form-control" id="qty-${item.itemId}" value="1">
          </div>
          <button class="btn btn-success w-100" onclick="addToCatalog('${item.itemId}')">Add to Catalog</button>
        </div>
      </div>
    </div>
  `).join("");
});

async function addToCatalog(itemId) {
  const points = document.getElementById(`points-${itemId}`).value;
  const quantity = document.getElementById(`qty-${itemId}`).value;
  const res = await fetch("/api/sponsor/catalog/add", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ item_id: itemId, points_cost: points, quantity_limit: quantity })
  });
  const data = await res.json();
  if (data.ok) {
    alert("Item added to catalog!");
    location.reload();
  } else {
    alert("Error: " + (data.error || "unknown"));
  }
}
</script>
{% endblock %}
