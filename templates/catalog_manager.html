{% extends "base.html" %}
{% block title %}Catalog Manager{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
  <h1 class="mb-0">Catalog Manager</h1>

  <!-- Points Ratio Control -->
  <div class="d-flex align-items-center gap-2">
    <label class="form-label mb-0">Points Ratio:</label>
    <div class="input-group" style="max-width: 280px;">
      <span class="input-group-text">1 USD =</span>
      <input type="number" class="form-control" id="points-per-dollar" min="1" step="1"
             value="{{ points_ratio or 100 }}">
      <span class="input-group-text">points</span>
    </div>
    <button class="btn btn-outline-primary" id="save-ratio-btn" type="button">Save</button>
  </div>

  <div class="btn-group ms-auto">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
      Add Local Item
    </button>
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#ebayModal">
      Browse eBay Catalog
    </button>
  </div>
</div>

<!-- Products Table -->
<table class="table table-hover">
  <thead class="table-light">
    <tr>
      <th>#</th>
      <th>Name</th>
      <th>Points Cost</th>
      <th>Quantity</th>
      <th>Source</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for product in products %}
    <tr>
      <th>{{ product.product_id }}</th>
      <td>
        {% if product.image_url %}
          <img src="{{ product.image_url }}" alt="" width="40" class="me-2 rounded">
        {% endif %}
        {{ product.name }}
      </td>
      <td>{{ product.points_cost }}</td>
      <td>{{ product.quantity }}</td>
      <td>{{ product.source_type|default('local')|capitalize }}</td>
      <td>
        <form action="{{ url_for('delete_product', product_id=product.product_id) }}" method="POST" style="display:inline;">
          <button type="submit" class="btn btn-sm btn-danger">Delete</button>
        </form>
      </td>
    </tr>
    {% else %}
    <tr><td colspan="6" class="text-center text-muted">No products found</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- Add Local Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('add_product') }}" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="addItemModalLabel">Add Local Product</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Product Name</label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Points Cost</label>
            <input type="number" class="form-control" name="points_cost" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Quantity</label>
            <input type="number" class="form-control" name="quantity" value="0">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Product</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- eBay Search Modal -->
<div class="modal fade" id="ebayModal" tabindex="-1" aria-labelledby="ebayModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ebayModalLabel">Browse eBay Catalog</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="ebay-search-form" class="input-group mb-3">
          <input type="text" class="form-control" id="ebay-search-query" placeholder="Search eBay products...">
          <button class="btn btn-primary" type="submit">Search</button>
        </form>
        <div class="alert alert-secondary py-2 small">
          Points auto-calculate from the item price using your ratio (<span id="ratio-inline">100</span> pts / $1). You can still edit points before adding.
        </div>
        <div id="ebay-results" class="row g-3"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- Points Ratio: load/save ---------- */
const RATIO_KEY = 'points_per_dollar';
const ratioInput = document.getElementById('points-per-dollar');
const ratioInline = document.getElementById('ratio-inline');
const saveBtn = document.getElementById('save-ratio-btn');

(function initRatio() {
  const serverVal = Number('{{ points_ratio or 0 }}') || 0;
  let ratio = serverVal > 0 ? serverVal : Number(localStorage.getItem(RATIO_KEY)) || 100;
  ratio = Math.max(1, Math.floor(ratio));
  ratioInput.value = ratio;
  ratioInline.textContent = ratio;
})();

saveBtn.addEventListener('click', () => {
  let ratio = Math.max(1, Math.floor(Number(ratioInput.value || 100)));
  ratioInput.value = ratio;
  ratioInline.textContent = ratio;
  localStorage.setItem(RATIO_KEY, String(ratio));
});

function getEffectiveRatio() {
  const serverVal = Number('{{ points_ratio or 0 }}') || 0;
  const localVal = Number(localStorage.getItem(RATIO_KEY)) || 0;
  return Math.max(1, Math.floor(serverVal || localVal || 100));
}

/* ---------- eBay Search + auto points ---------- */
document.getElementById("ebay-search-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const q = document.getElementById("ebay-search-query").value.trim();
  if (!q) return;

  const container = document.getElementById("ebay-results");
  container.innerHTML = "<p class='text-muted text-center'>Searching...</p>";

  const res = await fetch(`/api/sponsor/ebay/search?q=${encodeURIComponent(q)}`);
  const data = await res.json();

  if (!data.items || !data.items.length) {
    container.innerHTML = "<p class='text-center text-muted'>No results found.</p>";
    return;
  }

  const ratio = getEffectiveRatio();

  container.innerHTML = data.items.map(item => {
    const hasPrice = item.price && item.price.value && item.price.currency;
    const isUSD = hasPrice && (String(item.price.currency).toUpperCase() === 'USD');
    const autoPoints = isUSD ? Math.ceil(Number(item.price.value) * ratio) : 100;

    return `
      <div class="col-md-4">
        <div class="card h-100 shadow-sm">
          ${item.image ? `<img src="${item.image}" class="card-img-top" style="object-fit:contain;height:180px;">` : ''}
          <div class="card-body">
            <h6 class="card-title">${item.title}</h6>
            <p class="text-muted small">${item.condition || ''}</p>
            ${hasPrice ? `<p><strong>${item.price.value} ${item.price.currency}</strong></p>` : ''}
            <div class="input-group input-group-sm mb-2">
              <span class="input-group-text">Points</span>
              <input type="number" class="form-control" id="points-${item.itemId}" value="${autoPoints}">
            </div>
            <div class="input-group input-group-sm mb-3">
              <span class="input-group-text">Qty</span>
              <input type="number" class="form-control" id="qty-${item.itemId}" value="1">
            </div>
            <button class="btn btn-success w-100" onclick="addToCatalog('${item.itemId}')">Add to Catalog</button>
          </div>
        </div>
      </div>
    `;
  }).join("");
});

async function addToCatalog(itemId) {
  const points = document.getElementById(`points-${itemId}`).value;
  const quantity = document.getElementById(`qty-${itemId}`).value;
  const res = await fetch("/api/sponsor/catalog/add", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ item_id: itemId, points_cost: points, quantity_limit: quantity })
  });
  const data = await res.json();
  if (data.ok) {
    alert("Item added to catalog!");
    location.reload();
  } else {
    alert("Error: " + (data.error || "unknown"));
  }
}
</script>
{% endblock %}
