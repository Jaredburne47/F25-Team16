{% extends 'base.html' %}
{% block title %}Simulation Rules{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h2 class="mb-0">Simulation Rules</h2>
  </div>

  <!-- Add Rule Card -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      Add New Rule
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('add_rule') }}" class="m-0">
        <div class="row g-3">
          <!-- Type Selection -->
          <div class="col-md-4">
            <label for="ruleType" class="form-label fw-semibold">Type</label>
            <select class="form-select" id="ruleType" name="rule_type" required>
              <option value="">Select type</option>
              <option value="add_driver">Add Driver</option>
              <option value="remove_driver">Remove Driver</option>
              <option value="add_points">Add Points to Driver</option>
              <option value="remove_points">Remove Points from Driver</option>
            </select>
          </div>

          <!-- Driver Text Input (for Add/Remove Driver) -->
          <div class="col-md-4 d-none" id="driverTextSection">
            <label for="driverTextInput" class="form-label fw-semibold">Driver Username</label>
            <input type="text" class="form-control" id="driverTextInput" name="driver_username_text" placeholder="Enter username">
          </div>

          <!-- Driver Dropdown (for Add/Remove Points) -->
          <div class="col-md-4 d-none" id="driverDropdownSection">
            <label for="driverSelect" class="form-label fw-semibold">Select Driver</label>
            <select class="form-select" id="driverSelect" name="driver_username_dropdown">
              {% for driver in drivers %}
                <option value="{{ driver.username }}">{{ driver.username }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Points Input (only for points-related rules) -->
          <div class="col-md-4 d-none" id="pointsSection">
            <label for="pointsInput" class="form-label fw-semibold">Points</label>
            <input type="number" class="form-control" id="pointsInput" name="points" min="1" placeholder="e.g., 50">
          </div>

          <!-- Schedule -->
          <div class="col-md-4">
            <label for="scheduleInput" class="form-label fw-semibold">Schedule</label>
            <input type="text" class="form-control" id="scheduleInput" name="schedule" placeholder="e.g., Tuesdays 9 AM" required>
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button type="submit" class="btn btn-success btn-sm px-3">Add Rule</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Existing Rules Table -->
  <div class="card shadow-sm">
    <div class="card-header bg-secondary text-white">
      Existing Rules
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Type</th>
              <th>Driver</th>
              <th>Points</th>
              <th>Schedule</th>
              <th>Status</th>
              <th class="text-end" style="width: 200px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for rule in rules %}
            <tr>
              <td class="fw-semibold">{{ rule.type.replace('_', ' ').title() }}</td>
              <td>{{ rule.driver_username or '-' }}</td>
              <td>{{ rule.points or '-' }}</td>
              <td>{{ rule.schedule }}</td>
              <td>
                {% if rule.enabled %}
                  <span class="badge bg-success">Enabled</span>
                {% else %}
                  <span class="badge bg-secondary">Disabled</span>
                {% endif %}
              </td>
              <td class="text-end">
                <a href="{{ url_for('toggle_rule', rule_id=rule.id) }}" class="btn btn-warning btn-sm">
                  {{ 'Disable' if rule.enabled else 'Enable' }}
                </a>
                <a href="{{ url_for('remove_rule', rule_id=rule.id) }}" class="btn btn-outline-danger btn-sm"
                   onclick="return confirm('Delete this rule?');">
                  Delete
                </a>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="6" class="text-muted">No rules configured yet.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Inline behavior -->
<script>
  const typeSelect = document.getElementById('ruleType');
  const driverTextSection = document.getElementById('driverTextSection');
  const driverDropdownSection = document.getElementById('driverDropdownSection');
  const pointsSection = document.getElementById('pointsSection');

  typeSelect.addEventListener('change', function() {
    const val = this.value;
    if (val === 'add_driver' || val === 'remove_driver') {
      driverTextSection.classList.remove('d-none');
      driverDropdownSection.classList.add('d-none');
      pointsSection.classList.add('d-none');
    } else if (val === 'add_points' || val === 'remove_points') {
      driverDropdownSection.classList.remove('d-none');
      driverTextSection.classList.add('d-none');
      pointsSection.classList.remove('d-none');
    } else {
      driverTextSection.classList.add('d-none');
      driverDropdownSection.classList.add('d-none');
      pointsSection.classList.add('d-none');
    }
  });
</script>
{% endblock %}
