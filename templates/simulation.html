{% extends 'base.html' %}

{% block title %}Simulation Rules{% endblock %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-4">Simulation Rules</h2>

  <!-- Add Rule Card -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
      Add New Rule
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('add_rule') }}">
        <div class="row g-3">
          <!-- Type Selection -->
          <div class="col-md-4">
            <label for="ruleType" class="form-label">Type</label>
            <select class="form-select" id="ruleType" name="rule_type" required>
              <option value="">Select type</option>
              <option value="add_driver">Add Driver</option>
              <option value="remove_driver">Remove Driver</option>
              <option value="add_points">Add Points to Driver</option>
              <option value="remove_points">Remove Points from Driver</option>
            </select>
          </div>

          <!-- Driver Text Input (for Add/Remove Driver) -->
          <div class="col-md-4 d-none" id="driverTextSection">
            <label for="driverTextInput" class="form-label">Driver Username</label>
            <input type="text" class="form-control" id="driverTextInput" name="driver_username_text" placeholder="Enter username">
          </div>

          <!-- Driver Dropdown (for Add/Remove Points) -->
          <div class="col-md-4 d-none" id="driverDropdownSection">
            <label for="driverSelect" class="form-label">Select Driver</label>
            <select class="form-select" id="driverSelect" name="driver_username_dropdown">
              {% for driver in drivers %}
              <option value="{{ driver.username }}">{{ driver.username }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Points Input (only for points-related rules) -->
          <div class="col-md-4 d-none" id="pointsSection">
            <label for="pointsInput" class="form-label">Points</label>
            <input type="number" class="form-control" id="pointsInput" name="points" min="1">
          </div>

          <!-- Schedule -->
          <div class="col-md-4">
            <label for="scheduleInput" class="form-label">Schedule</label>
            <input type="text" class="form-control" id="scheduleInput" name="schedule" placeholder="e.g., Tuesdays 9 AM" required>
          </div>

          <div class="col-12">
            <button type="submit" class="btn btn-success mt-3">Add Rule</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Existing Rules Table -->
  <div class="card shadow-sm">
    <div class="card-header bg-secondary text-white">
      Existing Rules
    </div>
    <div class="card-body p-0">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Type</th>
            <th>Driver</th>
            <th>Points</th>
            <th>Schedule</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for rule in rules %}
          <tr>
            <td>{{ rule.type.replace('_', ' ').title() }}</td>
            <td>{{ rule.driver_username or '-' }}</td>
            <td>{{ rule.points or '-' }}</td>
            <td>{{ rule.schedule }}</td>
            <td>{{ 'Enabled' if rule.enabled else 'Disabled' }}</td>
            <td>
              <a href="{{ url_for('disable_rule', rule_id=rule.id) }}" class="btn btn-sm btn-warning">
                {{ 'Disable' if rule.enabled else 'Enable' }}
              </a>
              <a href="{{ url_for('delete_rule', rule_id=rule.id) }}" class="btn btn-sm btn-danger">Delete</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const typeSelect = document.getElementById('ruleType');
  const driverTextSection = document.getElementById('driverTextSection');
  const driverDropdownSection = document.getElementById('driverDropdownSection');
  const pointsSection = document.getElementById('pointsSection');

  typeSelect.addEventListener('change', function() {
    const val = this.value;

    if(val === 'add_driver' || val === 'remove_driver') {
      driverTextSection.classList.remove('d-none');
      driverDropdownSection.classList.add('d-none');
      pointsSection.classList.add('d-none');
    } else if(val === 'add_points' || val === 'remove_points') {
      driverDropdownSection.classList.remove('d-none');
      driverTextSection.classList.add('d-none');
      pointsSection.classList.remove('d-none');
    } else {
      driverTextSection.classList.add('d-none');
      driverDropdownSection.classList.add('d-none');
      pointsSection.classList.add('d-none');
    }
  });
</script>
{% endblock %}
